### CH0801. 云端应用的数据库

### 01. 课件

如何编写一个有数据库的 Web 应用，我们需要：

1、数据库的概念、分类和常规用法。

2、SQLite 数据库的概念、用法和与 Python 语言的关联。

3、实操小红书文案的后台数据库。

01 什么是数据库

在计算中，数据库是指有组织的数据集合或基于数据库管理系统 (DBMS) 的一种数据存储。

数据库有对应的数据库管理系统，要经过这个系统才能操作数据库，这个系统提供了输入、存储和检索等功能。

02 数据库的分类

数据库类型分为关系型数据库和非关系型数据库。

关系型数据库（Relational database）是建立在关系模型基础上的数据库，是一种以表格作为架构的数据库。关系模型最基本的组成要素是实体，关系和属性。

非关系型数据库：非关系数据库是一种不使用表格架构的数据库。

03 数据库的 CRUD 操作

04 什么是 SQL

结构化查询语言 (Structured Query Language, SQL) 是一种的特定领域的语言。SQL 定义了操作所有关系型数据库的统一标准，而 MySQL 和 Sqlite 是该标准或语言的具体实现。

网址：[SQL - Wikipedia](https://en.wikipedia.org/wiki/SQL)

05 什么是 SQLite

SQLite 是一个用 C 编程语言编写的数据库引擎。它最大的特点是就是无服务器设计。

适合移动设备、桌面应用或任何需要单一文件数据库的场景。

网址：[SQLite Download Page](https://www.sqlite.org/download.html)

SQLlte Browser：[Downloads - DB Browser for SQLite](https://sqlitebrowser.org/dl/)

06 SQLite 的数据类型和语法

网址：[SQLite 教程 | 菜鸟教程](https://www.runoob.com/sqlite/sqlite-tutorial.html)

SQLite 的数据类型：

数据类型包括：空值 - Null、整数 - INTEGER、浮点 - REAL、文本 - TEXT、任意类型 - BLOB。

数据类型的约束：Not Null、Default、Unique、Primary、Check。

数据库的索引是一种特殊的查找表，数据库搜索引擎用来加快数据检索。

SQLite 的语法：

Database：数据库的增删、导入、导出数据。

Table：表的增删、数据的增删改查。

Condition：设置不同条件查找数据。

Other：时间及其他辅助功能。

07 SQLite 的实操流程

Sqlite => database => table => entities => attribure => type

08 SQL 的风险

1、SQL 注入风险：使用一段 SQL 代码来操纵数据库并访问可能有价值的信息。

2、代码的可读性和维护性：当 SQL 语句与 Python 代码混合时，使得代码难以阅读和维护。

3、对象与数据不一致：在传统的 SQL 中，你需要手动将查询结果转化为 Python 对象，或者将 Python 对象转化为 SQL 插入/更新语句。这个过程容易出错且重复。

09 什么是 ORM

参考网址：

[ORM 实例教程 - 阮一峰的网络日志](https://www.ruanyifeng.com/blog/2019/02/orm-tutorial.html)

ORM 是「对象-关系映射」（Object/Relational Mapping）的缩写，是一种在关系数据库和面向对象编程语言的堆之间转换数据的编程技术。

数据库的表（table）-> 类（class）

记录（record，行数据）-> 对象（object）

字段（field）-> 对象的属性 (attribute)

10 Python 中的 ORM

python 中的 ORM 是 SQLAlchemy。

参考网址：

[SQLAlchemy - The Database Toolkit for Python](https://www.sqlalchemy.org/)

11 实操：小红书文案生成器的后台数据库

12 实操：如何部署云端应用

coding 关联腾讯云：

[如何在腾讯轻量应用服务器部署 fastapi - 飞书云文档](https://p7een9o397.feishu.cn/docx/CxxgdLixnox1jWxjWaYcnXadnjh)

### 02. 实操是遇到的问题

1、建完数据库没法在里面执行 SQL 语句。

也是询问 GPT 的时候无意中，在其问题里 get 了自己反的错误。我新建数据库命令的时候只输入了 demo，没有带文件类型名。应该输入完成的 demo.db，然后进去后就可以执行 SQL 了。

2、安装项目配套的三方包时报错，原因是需要 Python3.8 版本，目前自己的是 Python3.7 的。

解决方案：好在在 conda 虚拟环境中升版 Python 很方便，而且不会影响到其他虚拟环境的包。在虚拟环境中运行下面命令即可。

conda install python=3.8

后来发现有很多其他包，要求 Python 最高的版本是 3.10，就索性升级到了 3.10。

3、安装三方包是遇到的一系列问题。

那个 requirements.txt 有不少包，重复了 2 次，而且不同的版本，会冲突，要删除。

安装 jnius 包时，由于缺少 Cython 这个必要的依赖，导致安装失败。要么手动安装 Cython 包：pip install Cython。要么把 Cython 包的信息直接写到 requirements.txt 里：Cython==3.0.5。

安装不了包 xmlrpclib。问 GPT 后的回复：

错误信息表明你尝试安装的 `xmlrpclib` 版本1.0.1在PyPI上不存在。`xmlrpclib` 是Python 2的一个标准库，用于处理XML-RPC。在Python 3中，这个库已经被重命名并集成到了 `xmlrpc.client` 模块中，所以不再需要单独安装。

如果你的代码是为Python 2编写的，你应该考虑将其升级到Python 3。如果升级不是一个选项，你需要确认你使用的是Python 2环境，并且不需要安装 `xmlrpclib`，因为它已经是标准库的一部分了。

如果你正在使用Python 3，你应该将代码中的 `xmlrpclib` 引用更新为 `xmlrpc.client`。例如，如果你的代码中有这样的语句：

```python
import xmlrpclib
```

你应该将其更改为：

```python
import xmlrpc.client
```

并且确保你的代码中的其他 `xmlrpclib` 引用也做相应的更新。

如果你确实需要安装一个第三方包，确保你有正确的包名和版本号。你可以在PyPI官网（https://pypi.org/）搜索你需要的包来确认。如果是私有包或者内部服务器上的包，你需要确保你的pip配置能够访问正确的服务器或者索引。

最终还是没装上三方包 jnius。看后续项目是不是真的需要用这个包，到时再解决。（2023-11-16）


### 03. 实操获取的知识点

1、函数修饰器。

函数作为一个参数传递给另一个函数，高阶函数的概念。

### 04. 其他

基础作业是让 GPT 做的。


分享

2023 年 11 月 27 日 - AI 编程答疑文字整理（有增删改）

阏男秀·今天 00:09:16

2023 年 11 月 27 日答疑，文字整理，有增删改

1、一休：MVC 的 V 可以讲讲吗

答：MVC 的 V，后面有时间做一场分享，这样就把 MVC 三个都讲完了。最主要是理解浏览器的渲染机制。

2、洋仔 CyrusF 前后端沟通的机制是什么？

答：最核心的是 http 协议。就课程视频里面所说，前端可以使用表单、ajax、fetch 功能等，后端只需要提供 http 接口即可。

3、晓霖 Q1. 部署到云服务器后，http 会面临一些权限问题，如果想配置成 https，有没有比较成熟的方案？

答：要配置 https，最好的方案只能是走域名方案，申请域名之后再去申请 ssl 证书，然后使用 nginx 配置。但是由于国内建站比较麻烦，需要做备案等。所以需要使用国外的服务器和域名。IP 也可以做成 https，但是很麻烦，只能私人使用。

Q2. 背景：SQL 的学生表没有设置 id 列，人名是 primary_key。sqlalchemy 统计学生人数时，同名的学生会漏计。提问：建表之后可否增加 id 列，设为 primary_key，系统自动填充？（GPT 说要重新建一个表，把数据移过去）

答：这个可能和 sqlite 的机制有关，其他数据库应该没问题，最主要是找到对应的 SQL 改表语句。ALERT table_name...，如果执行不成功，那就是 sqlite 不支持了。所以只能按 gpt 建议来。所以需要提醒大家的是，数据表一定要设计好，真实的工作场景是，设计好数据表的字段就不会再变动了，后期最多加字段，加数据表。

4、学习科学践行者实例演示一下 debug 的过程，比如 js 出问题，后台出问题，如何设断点调试

答：js 调试，重点在于谷歌浏览器的 Sources 面板，这一部分 gpt 估计帮不上太多的忙，可参考这边文章：https://cloud.tencent.com/developer/article/1503476

5、晓霖使用 fastapi+sqlalchemy 开发的小型网站，除了腾讯云、阿里云这种云服务，还可以部署在哪些平台？

答：腾讯云，阿里云这些一般提供的都是云主机，除了国内云主机平台，还可以找一些云服务平台，这里推荐国外的 render 平台，https://render.com/ 我测试过，可以运行 fastapi，有一定的免费帐号额度。另外国外的云服务器可以考虑这几家：heroku 和 Vultr。

6、冰瓜王部署在阿里云之上通过外网可以访问，但过不久进程就被关闭了，如何保证能够长期运行

答：根据我猜测，是没有在后台运行进程，由于终端关闭了，程序就自动停止了。可以参考我写的部署文档如何在腾讯轻量应用服务器部署 fastapi 最后一部分，如何使用 screen 工具把 web 终端切换到后台。

7、Jun@xing.ai 通过 chatgpt 辅助，做一个简单功能的 web 应用还是可以的，但只要稍微一复杂，就比较难完成了，比如做一个可以生成海报的 web 工具，或者刷新界面就生成白噪音和搭配图片的网站等等功能，这种需求要想实现，有什么突破口或者学习建议吗？

答：对于生成海报 web 等这些工具，根据我的经验，在 gpt 出现以前，这个功能至少需要有一两年的开发经验，也就是达到了初级工程师的水平，才能独立完成。但是现在有了 gpt，可能会对于新手来说不需要那么多时间。所以首先要清楚这些功能是很复杂的，只能是慢慢积累开发经验，比如多了解一些 github 的小项目。

那么对于复杂功能应该如何做，首先就是需要快速做一个原型验证，可以使用我们的课程教的知识，cli 应用，先从最小的 cli 工具开始，关注输入 - 处理 - 输出的流程，比如读取一个本地图片文件，然后代码中如何处理，最后输出到一个文件夹，我上一周给大家调试智谱 sdk 就是一个很好的示范。另外因为你是要做海报，还需要学习一些图片处理的工具，比如 pillow 库。快速验证完 demo 后，再开始上 web，因为这里设计到前端界面设计，还有和后端的通信等功能，但这些知识点是独立的，是可以迁移的。

小任务可以交给 gpt，但是怎么组合这些功能，只能我们人来。就如方军老师所说的，ai 还不能达到端到端输出，还需要人的参与，human-in-the-loop。

8、晓霖如果一个网站有多个页面，例如主页显示小红书生成器，之前生成并保存的文案放在一个子页面，从便于日后维护的角度，推荐的文件夹结构是怎样的？

答：参考 django 目录结构，这个就是可扩展性最好的结构了。

李辉老师在他写的《Flask Web 开发实战》一书中提到三种项目组织结构：功能式架构、分区式架构、混合式架构。其中： 功能式架构按程序功能来组成，比如 templates 存放模板，static 存放静态文件，models 存放模型，services 存放服务，apis 存放接口。如果网站功能简单，并且各个功能紧密耦合，可以使用这个架构。

templates/

static/

models/

services/

apis/

分区式架构，则按业务来区分，比如 auth 存放认证功能，zhipuai 存放有关智谱的代码，templates 和 static 不变

auth/

zhipuai/

templates/

static/

混合式架构，就是混合使用上面的架构。在分区式架构下继续使用功能式架构。目前我工作中由于使用 django，所以直接使用 django 固定的结构，也就是混合式架构，这种方式能应付各种以后没有计划的需求和功能。只需要在顶层目录继续加一个业务文件夹就行了。

9、阿盛在网页中需要新增加一个功能时，会需要在前后端写不同的代码，有没有比较常用的工作流程？比如要在文案生成器的页面里加个「批量导出为表格」的功能，在开发时会怎么逐步实现？

答：正常流程是这样，从 MVC 的 model 层开始，数据库需不需要加字段，或者加数据表。完成之后，开始写后端接口，最后前端根据接口实现功能。

再说细一点的话，对于导出为表格这个功能，需要先确定导出哪些数据，需不需要连接多个表，这个可以使用数据库工具进行操作和测试，这里最好使用 SQL 编写，不需要用到 ORM。SQL 编写好后，就可以开发后端接口，提供给前端，前端设计页面，思考怎么展示比较好看，最后调用接口实现功能。之后就是去测试功能了。

所以一个流程是这样的，数据库先动，然后是后端提供接口，最后是前端编写页面，最最后是测试。

20231127：初稿